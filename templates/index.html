<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insights Machine Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #1e293b;
            overflow-y: auto;
            border-right: 1px solid #334155;
            padding: 1rem;
        }
        .main-content {
            margin-left: 280px;
            padding: 2rem;
        }
        .input-field {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #e2e8f0;
        }
        .btn {
            transition: all 0.3s ease;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: #e2e8f0;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary:hover {
            background-color: #6b7280;
        }
        .processing-status {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #1e293b;
            border-radius: 0.375rem;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            background-color: #2d3748;
            color: #e2e8f0;
            border: none;
            border-radius: 0.375rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: #ffffff;
        }
        .tab-content {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #1e293b;
            border-radius: 0.375rem;
        }
        .chunk-summary {
            background-color: #2d3748;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .chunk-summary h4 {
            color: #60a5fa;
            margin-bottom: 0.5rem;
        }
        .streaming-content {
            max-height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background-color: #2d3748;
            border-radius: 0.375rem;
        }
        .history-item {
            padding: 0.75rem;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .history-item:hover {
            background-color: #2d3748;
        }
        .history-title {
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        .history-date {
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .landing-description {
            background-color: #2d3748;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .new-analysis-icon {
            cursor: pointer;
            color: #60a5fa;
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }
        .new-analysis-icon:hover {
            color: #3b82f6;
        }
        .final-report h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #60a5fa;
            font-size: 1.25rem;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="flex">
        <div class="sidebar">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-blue-400">Query History</h2>
                <i class="fas fa-plus-circle new-analysis-icon" onclick="startNewAnalysis()" title="Start New Analysis"></i>
            </div>
            <div id="history-list">
                <!-- Query history items will be dynamically added here -->
            </div>
        </div>
        <div class="main-content">
            <header class="mb-8">
                <h1 class="text-4xl font-bold text-blue-400 mb-2">Insights Machine Pro</h1>
                <p class="text-xl text-gray-400">Transform your content into actionable insights</p>
            </header>

            <div class="landing-description mb-8">
                <h2 class="text-2xl font-semibold mb-4">Welcome to Insights Machine Pro</h2>
                <p class="mb-4">Our advanced AI-powered tool helps you extract valuable insights from text or YouTube videos. Here's how to get started:</p>
                <ol class="list-decimal list-inside space-y-2">
                    <li>Choose your input type: Text or YouTube link</li>
                    <li>Enter your content or paste a YouTube URL</li>
                    <li>Select the type of report you want: Professional Analyst Report or Engaging Medium Blog Post</li>
                    <li>Click "Generate Insights" and watch as our AI analyzes your content</li>
                    <li>Review your results in the Transcript, Chunk Summaries, and Final Report tabs</li>
                </ol>
            </div>

            <form id="analysis-form" class="space-y-6 bg-gray-800 p-6 rounded-lg shadow-lg">
                <div>
                    <h2 class="text-xl font-semibold mb-2">1. Choose Input Type</h2>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio text-blue-500" name="input_type" value="text" checked>
                            <span class="ml-2">Text Input</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio text-blue-500" name="input_type" value="youtube">
                            <span class="ml-2">YouTube Link</span>
                        </label>
                    </div>
                </div>
                
                <textarea id="transcript" name="transcript" placeholder="Enter your text here..." class="w-full p-3 input-field rounded-md min-h-[200px]" required></textarea>
                <input id="youtube_link" type="url" name="youtube_link" placeholder="Enter YouTube video URL" class="w-full p-3 input-field rounded-md" style="display: none;">
                
                <div>
                    <h2 class="text-xl font-semibold mb-2">2. Select Report Type</h2>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio text-blue-500" name="report_type" value="analyst" checked>
                            <span class="ml-2">Professional Analyst Report</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" class="form-radio text-blue-500" name="report_type" value="medium">
                            <span class="ml-2">Engaging Medium Blog Post</span>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-full">Generate Insights</button>
            </form>

            <div id="processing-status" class="processing-status mt-4" style="display: none;">
                <h3 class="text-lg font-semibold mb-2">Processing Status</h3>
                <p id="status-message"></p>
                <div class="mt-2 bg-gray-700 rounded-full">
                    <div id="progress-bar" class="bg-blue-500 text-xs font-medium text-blue-100 text-center p-0.5 leading-none rounded-full" style="width: 0%"></div>
                </div>
                <div id="streaming-content" class="streaming-content mt-4"></div>
            </div>

            <div id="results" class="mt-8" style="display: none;">
                <div class="mb-4">
                    <button class="tab-button active" data-tab="transcript">Transcript</button>
                    <button class="tab-button" data-tab="chunk-summaries">Chunk Summaries</button>
                    <button class="tab-button" data-tab="final-report">Final Report</button>
                </div>
                <div id="transcript-tab" class="tab-content">
                    <h3 class="text-xl font-semibold mb-2">Transcript</h3>
                    <pre id="transcript-content" class="whitespace-pre-wrap"></pre>
                </div>
                <div id="chunk-summaries-tab" class="tab-content" style="display: none;">
                    <h3 class="text-xl font-semibold mb-2">Chunk Summaries</h3>
                    <div id="chunk-summaries-content"></div>
                </div>
                <div id="final-report-tab" class="tab-content" style="display: none;">
                    <h3 class="text-xl font-semibold mb-2">Final Report</h3>
                    <h4 id="report-title" class="text-lg font-semibold"></h4>
                    <p id="report-subtitle" class="text-gray-400 mb-4"></p>
                    <div id="final-report-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function loadAnalysis(id) {
            window.location.href = `/result/${id}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('analysis-form');
            const processingStatus = document.getElementById('processing-status');
            const statusMessage = document.getElementById('status-message');
            const progressBar = document.getElementById('progress-bar');
            const streamingContent = document.getElementById('streaming-content');
            const results = document.getElementById('results');

            // Fetch and display query history
            fetchQueryHistory();

            function fetchQueryHistory() {
                fetch('/get_history')
                    .then(response => response.json())
                    .then(data => {
                        const historyList = document.getElementById('history-list');
                        historyList.innerHTML = data.map(item => `
                            <div class="history-item" onclick="loadAnalysis(${item.id})">
                                <p class="history-title">${item.report_title}</p>
                                <p class="history-date">${formatDate(new Date(item.created_at))}</p>
                            </div>
                        `).join('');
                    })
                    .catch(error => console.error('Error fetching history:', error));
            }

            function formatDate(date) {
                const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleDateString('en-US', options);
            }

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(form);
                
                processingStatus.style.display = 'block';
                results.style.display = 'none';
                statusMessage.textContent = 'Starting analysis...';
                progressBar.style.width = '0%';
                streamingContent.innerHTML = '';

                fetch('/', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    const reader = response.body.getReader();
                    return new ReadableStream({
                        start(controller) {
                            function push() {
                                reader.read().then(({ done, value }) => {
                                    if (done) {
                                        controller.close();
                                        return;
                                    }
                                    controller.enqueue(value);
                                    push();
                                });
                            }
                            push();
                        }
                    });
                })
                .then(stream => new Response(stream))
                .then(response => response.text())
                .then(text => {
                    const lines = text.split('\n\n');
                    let progress = 0;
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.slice(6));
                            updateStatus(data);
                            if (data.status === "Complete") {
                                displayResults(data);
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    statusMessage.textContent = 'An error occurred during analysis.';
                });
            });

            function updateStatus(data) {
                statusMessage.textContent = data.status;
                if (data.status === "Processing chunk") {
                    progress += 10;
                    progressBar.style.width = `${Math.min(progress, 90)}%`;
                    streamingContent.innerHTML += `<p>${data.status}: ${data.summary || ''}</p>`;
                    streamingContent.scrollTop = streamingContent.scrollHeight;
                } else if (data.status === "Complete") {
                    progressBar.style.width = '100%';
                }
            }

            function displayResults(data) {
                document.getElementById('transcript-content').textContent = data.transcript;
                const chunkSummariesContent = document.getElementById('chunk-summaries-content');
                chunkSummariesContent.innerHTML = data.chunk_summaries.map((summary, index) => 
                    `<div class="chunk-summary mb-8">
                        <h4 class="text-xl font-semibold mb-4 text-blue-300">Chunk ${index + 1}</h4>
                        <div class="pl-4 border-l-2 border-blue-500">
                            ${formatAnalystReport(summary)}
                        </div>
                    </div>`
                ).join('');
                document.getElementById('report-title').textContent = data.report_title;
                document.getElementById('report-subtitle').textContent = data.report_subtitle;
                document.getElementById('final-report-content').innerHTML = formatFinalReport(data.final_summary);
                results.style.display = 'block';
                processingStatus.style.display = 'none';
            }

            function formatAnalystReport(text) {
                // Replace **text** with <strong>text</strong> for bold text
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-300">$1</strong>');
                
                // Add spacing between paragraphs
                text = text.replace(/\n\n/g, '</p><p class="mb-4">');
                
                // Add bullet points
                text = text.replace(/^- /gm, '• ');
                
                // Wrap the text in paragraph tags
                text = '<p class="mb-4">' + text + '</p>';
                
                return text;
            }

            function formatFinalReport(text) {
                // Replace **text** with <strong>text</strong> for bold text
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-300">$1</strong>');
                
                // Add spacing between paragraphs and ensure titles are on their own line
                text = text.replace(/\n\n/g, '</p><p class="mb-4">');
                text = text.replace(/(<strong.*?<\/strong>)/g, '</p><h3>$1</h3><p>');
                
                // Add bullet points
                text = text.replace(/^- /gm, '• ');
                
                // Wrap the text in paragraph tags
                text = '<p class="mb-4">' + text + '</p>';
                
                return `<div class="final-report">${text}</div>`;
            }

            // Tab switching logic
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.style.display = 'none');
                    button.classList.add('active');
                    document.getElementById(`${tabName}-tab`).style.display = 'block';
                });
            });

            // Input type switching logic
            const inputTypeRadios = document.querySelectorAll('input[name="input_type"]');
            const textArea = document.getElementById('transcript');
            const urlInput = document.getElementById('youtube_link');

            inputTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'text') {
                        textArea.style.display = 'block';
                        urlInput.style.display = 'none';
                        textArea.required = true;
                        urlInput.required = false;
                    } else {
                        textArea.style.display = 'none';
                        urlInput.style.display = 'block';
                        textArea.required = false;
                        urlInput.required = true;
                    }
                });
            });
        });

        function startNewAnalysis() {
            document.getElementById('analysis-form').reset();
            document.getElementById('results').style.display = 'none';
            document.getElementById('processing-status').style.display = 'none';
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>